name: "bearer-pr-test"
description: ""
inputs:
  GITHUB_TOKEN:
    description: "GitHub Token from the repository"
    required: true


env:
  gh_pages_url: https://tetrisiq.github.io/bearer-pr-test/
  ph_page_repo: TetrisIQ/bearer-pr-test

runs:
  using: "composite"
  steps:
    - uses: "actions/checkout@v4"

    - id: check
      uses: bearer/bearer-action@v2
      with:
        format: json
        output: securityTest.json
        exit-code: 0
    - id: findings
      shell: bash
      run: echo security_finding=$(cat securityTest.json | jq '. != {}')  >> $GITHUB_OUTPUT

    - id: gen_html
      if: steps.findings.outputs.security_finding == 'true'
      name: Generate HTML
      uses: bearer/bearer-action@v2
      with:
        format: html
        output: securityTest.html
        exit-code: 0
    - uses: actions/github-script@v6
      id: "comment_to_pr"
      if: steps.findings.outputs.security_finding == 'true'
      name: "Comment to PR"
      with:
        script: 
          

    - id: upload_artifact
      if: steps.findings.outputs.security_finding == 'true'
      uses: actions/upload-artifact@v3
        with:
          name: securityHTML
          path: securityTest.html
          
    - id: checkout      
      if: steps.findings.outputs.security_finding == 'true'
      uses: actions/checkout@v4
        with:
          ref: gh-pages
          repository: ${{ env.gh_page_repo }}

    - id: download_artifact
      if: steps.findings.outputs.security_finding == 'true'
      - uses: actions/download-artifact@v3
        with:
          name: securityHTML
          path: ${{ github.repository }}/pr/${{ github.event.number }}/security

    - id: upload_html_to_page
      if: steps.findings.outputs.security_finding == 'true'
      name: "Upload to GH Page branch"
      run: |
          git config --global user.name 'TetrisIQ'
          git config --global user.email '24246993+TetrisIQ@users.noreply.github.com'
          git add . 
          git commit -am "Automated report"
          git push

